<!-- Imports polymer -->
<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/google-signin/google-signin-aware.html">
<link rel="import" href="/bower_components/google-signin/google-signin.html">
<link rel="import" href="/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/my-app.html">
<!-- Defines element markup -->
<dom-module id="auth-guard">
    <template>
        <google-signin-aware hosted-domain="lunatech.com" client-id="172845937673-smq0kn52ie1spg9irdrhk4stgk7nrp0g.apps.googleusercontent.com"></google-signin-aware>

        <iron-ajax
          id="lunatechProfileLoader"
          url="/api/people/me"
          content-type="application/json"
          handle-as="json"
          last-response="{{lunatechProfile}}"></iron-ajax>

        <template is="dom-if" if="{{!authenticated}}">
          <paper-dialog id="login-dialog" modal="true" opened="true">
            <h2>Lunatech Competence Center</h2>
            <paper-dialog-scrollable>
              Please sign in with your Lunatech G-Suite account!
            </paper-dialog-scrollable>
            <div class="buttons">
              <google-signin width="wide" height="tall" hosted-domain="lunatech.com" client-id="172845937673-smq0kn52ie1spg9irdrhk4stgk7nrp0g.apps.googleusercontent.com"></google-signin>
            </div>
          </paper-dialog>
        </template>

        <template is="dom-if" if="{{authenticated}}">
          <my-app basic-profile={{basicProfile}} lunatech-profile={{lunatechProfile}} id-token={{idToken}}></my-app>
        </template>
    </template>
</dom-module>

<!-- Registers custom element -->
<script>
Polymer({
    is: 'auth-guard',
    properties: {

      // Authenticated means authenticated with Google Signin + lunatech profile fetched.
      authenticated: {
        type: Boolean,
        value: false,
        computed: 'computeAuthenticated(basicProfile, lunatechProfile)'
      },

      basicProfile: {
        type: Object
      },

      lunatechProfile: {
        type: Object
      },

      idToken: {
        type: String
      }
    },

    listeners: {
      'google-signin-success': '_signinSuccess',
      'google-signed-out': '_signedOut',
      'logout': '_handleLogout'
    },

    computeAuthenticated: function(googleAuthenticated, profileLoaded) {
      return (googleAuthenticated !== null) && (profileLoaded !== null);
    },

    _handleLogout: function() {
      this.basicProfile = null;
      this.$$('google-signin-aware').signOut();
    },

    // TODO, google-signin-aware docs says: "You can bind to isAuthorized property to monitor authorization state."
    _signinSuccess: function() {
      // See the reference: https://developers.google.com/identity/sign-in/web/reference
      googleAuth = gapi.auth2.getAuthInstance();
      currentUser = googleAuth.currentUser.get();
      basicProfile = currentUser.getBasicProfile();
      imageUrl = basicProfile.getImageUrl();

      // TODO, do a domain check?
      domain = currentUser.getHostedDomain();

      this.basicProfile = basicProfile;
      this.idToken = currentUser.getAuthResponse().id_token;

      this.$.lunatechProfileLoader.headers = { "X-ID-Token": this.idToken }
      this.$.lunatechProfileLoader.generateRequest();

      this.$$("#login-dialog").close();
    },

    _signedOut: function() {
      this.authenticated = false;
      this.basicProfile = null;
      this.idToken = null;
      this.lunatechProfile = null;
    }

});
</script>
